C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 1   


C51 COMPILER V9.50a, COMPILATION OF MODULE TELE_T_R
OBJECT MODULE PLACED IN TELE_T_R.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE TELE_T_R.c LARGE OPTIMIZE(7,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*****************************************************************
   2                                     TELE_T_R.C  file
   3          
   4          Ö÷Òª¹¦ÄÜ£º¸ºÔð±¨ÎÄµÄ·¢ËÍºÍ½ÓÊÕ£¬¿ÕÏÐ¼ì²â£¬³åÍ»±ÜÃâ¼°CRCÐ§Ñé
   5                    £¨Ïàµ±ÓÚOSI²Î¿¼Ä£ÐÍÖÐµÄMAC×Ó²ãµÄÊµÏÖ£©
   6          
   7          ´´½¨Ê±¼ä£º2015.10.31
   8          *****************************************************************/
   9          /*--------------------------------------------------------------*/
  10          /*---------------------------Í·ÎÄ¼þ-----------------------------*/
  11          /*--------------------------------------------------------------*/
  12          #include <STC89C5xRC.h>
  13          #include "TELE_T_R.h"
  14          #include "CONFIG.h"
  15          #include "TELE_MANAGE.h"
  16          /*--------------------------------------------------------------*/
  17          
  18          
  19          
  20          unsigned char data Tele_RT;                            //±¨ÎÄ½ÓÊÕÖ¡´ÎÊý£»
  21          unsigned char data CRC_R;                              //½ÓÊÕ±¨ÎÄµÄCRCÐ§ÑéÂë
  22          
  23          bit           Tele_Ring;                             //±¨ÎÄÕýÔÚ½ÓÊÕ±êÖ¾Î»
  24          unsigned char data r[15];                              //ÔÝÊ±´æ·Å½ÓÊÕµÄ±¨ÎÄ
  25          
  26          unsigned char data Tele_TT;                            //·¢ËÍ±¨ÎÄÖ¡´ÎÊý
  27          bit           Tele_TF;                  //±¨ÎÄ·¢ËÍ±êÖ¾Î»
  28          unsigned char data CRC_T;                              //·¢ËÍ±¨ÎÄµÄCRCÐ§ÑéÂë
  29          
  30          unsigned char data t[15];                              //ÔÝÊ±´æ·ÅÐèÒª·¢ËÍµÄ±¨ÎÄ
  31          unsigned char data Frame_Num_T;                        //´ý·¢ËÍ±¨ÎÄµÄÖ¡ÊýÄ¿
  32          unsigned char data Retry_Time;                         //±¨ÎÄ·¢ËÍÖØÊÔ´ÎÊý
  33          bit           data Tele_Second;                        //·¢ËÍµÚ¶þÖ¡Êý¾Ý±êÖ¾Î»
  34          
  35          bit           Idle_Cheak;                         //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬¿ÕÏÐ¼ì²â
  36          unsigned char data Idle_Cheak_Counter;                 //¿ÕÏÐ¼ì²â¼ÆÊýÆ÷
  37          
  38          bit           GZC_Control;                        //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬GZC¿ØÖÆ
  39          unsigned char data GZC_Control_Counter;                //GZC¿ØÖÆ¼ÆÊýÆ÷
  40          
  41          bit           Back_Read_Cheak;                    //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬»Ø¶Á¿ØÖÆ
  42          unsigned char data Back_Read_Counter;                  //»Ø¶Á¿ØÖÆ¼ÆÊýÆ÷
  43          
  44          bit           Over_Time_Cheak;                    //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬³¬Ê±¼ì²â
  45          unsigned char data Over_Time_Counter;                  //³¬Ê±¼ì²â¼ÆÊýÆ÷
  46          
  47          bit           Ack_Cheak;                          //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬È·ÈÏ³¬Ê±¼ì²â
  48          unsigned char data Ack_Cheak_Counter;                  //È·ÈÏ³¬Ê±¼ì²â¼ÆÊýÆ÷
  49          
  50          bit           Ack_Flag;                           //·¢ËÍÓ¦´ð±êÖ¾Î»
  51          
  52          unsigned char Attribute;
  53          
  54          bit Module_Operate_Flag;
  55          bit Group_Operate_Flag;
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 2   

  56          //sbit led0=P2^0;
  57          //sbit led1=P2^2;
  58          unsigned char Group_b=0;
  59          unsigned char Group_a=0;
  60          //CRCÐ§ÑéÂë±í
  61          unsigned char code CRC_Table[]=
  62          {
  63            0x00,0x5E,0xBC,0xE2,0x61,0x3F,0xDD,0x83,0xC2,0x9C,0x7E,0x20,0xA3,0xFD,0x1F,0x41,
  64            0x9D,0xC3,0x21,0x7F,0xFC,0xA2,0x40,0x1E,0x5F,0x01,0xE3,0xBD,0x3E,0x60,0x82,0xDC,
  65            0x23,0x7D,0x9F,0xC1,0x42,0x1C,0xFE,0xA0,0xE1,0xBF,0x5D,0x03,0x80,0xDE,0x3C,0x62,
  66            0xBE,0xE0,0x02,0x5C,0xDF,0x81,0x63,0x3D,0x7C,0x22,0xC0,0x9E,0x1D,0x43,0xA1,0xFF,
  67            0x46,0x18,0xFA,0xA4,0x27,0x79,0x9B,0xC5,0x84,0xDA,0x38,0x66,0xE5,0xBB,0x59,0x07,
  68            0xDB,0x85,0x67,0x39,0xBA,0xE4,0x06,0x58,0x19,0x47,0xA5,0xFB,0x78,0x26,0xC4,0x9A,
  69            0x65,0x3B,0xD9,0x87,0x04,0x5A,0xB8,0xE6,0xA7,0xF9,0x1B,0x45,0xC6,0x98,0x7A,0x24,
  70            0xF8,0xA6,0x44,0x1A,0x99,0xC7,0x25,0x7B,0x3A,0x64,0x86,0xD8,0x5B,0x05,0xE7,0xB9,
  71            0x8C,0xD2,0x30,0x6E,0xED,0xB3,0x51,0x0F,0x4E,0x10,0xF2,0xAC,0x2F,0x71,0x93,0xCD,
  72            0x11,0x4F,0xAD,0xF3,0x70,0x2E,0xCC,0x92,0xD3,0x8D,0x6F,0x31,0xB2,0xEC,0x0E,0x50,
  73            0xAF,0xF1,0x13,0x4D,0xCE,0x90,0x72,0x2C,0x6D,0x33,0xD1,0x8F,0x0C,0x52,0xB0,0xEE,
  74            0x32,0x6C,0x8E,0xD0,0x53,0x0D,0xEF,0xB1,0xF0,0xAE,0x4C,0x12,0x91,0xCF,0x2D,0x73,
  75            0xCA,0x94,0x76,0x28,0xAB,0xF5,0x17,0x49,0x08,0x56,0xB4,0xEA,0x69,0x37,0xD5,0x8B,
  76            0x57,0x09,0xEB,0xB5,0x36,0x68,0x8A,0xD4,0x95,0xCB,0x29,0x77,0xF4,0xAA,0x48,0x16,
  77            0xE9,0xB7,0x55,0x0B,0x88,0xD6,0x34,0x6A,0x2B,0x75,0x97,0xC9,0x4A,0x14,0xF6,0xA8,
  78            0x74,0x2A,0xC8,0x96,0x15,0x4B,0xA9,0xF7,0xB6,0xE8,0x0A,0x54,0xD7,0x89,0x6B,0x35
  79          };
  80          /*--------------------------------------------------------------*/
  81          /*------------------±¨ÎÄ·¢ËÍÓë½ÓÊÕÄ£¿é³õÊ¼»¯-------------------*/
  82          /*--------------------------------------------------------------*/
  83          void init_tele_t_r()             
  84          {
  85   1        PDI=0;                                             //½«×ÜÏßÉèÖÃÎª¸ß×è
  86   1        Tele_RT=0;                                         //±¨ÎÄ½ÓÊÕÖ¡´ÎÊý
  87   1          CRC_R=0;                                           //½ÓÊÕ±¨ÎÄµÄCRCÐ§ÑéÂë
  88   1        
  89   1        Tele_Ring=0;                                //±¨ÎÄÕýÔÚ½ÓÊÕ±êÖ¾Î»
  90   1      
  91   1          Tele_TT=0;                                         //·¢ËÍ±¨ÎÄÖ¡´ÎÊý
  92   1        Tele_TF=0;
  93   1          CRC_T=0;                                           //·¢ËÍ±¨ÎÄµÄCRCÐ§ÑéÂë
  94   1       
  95   1        Retry_Time=0;
  96   1        
  97   1        Tele_Second=0;                                     //·¢ËÍµÚ¶þÖ¡Êý¾Ý±êÖ¾Î»
  98   1        
  99   1        Idle_Cheak=0;                                      //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬¿ÕÏÐ¼ì²â
 100   1        Idle_Cheak_Counter=0;                              //¿ÕÏÐ¼ì²â¼ÆÊýÆ÷
 101   1        
 102   1        GZC_Control=0;                                     //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬GZC¿ØÖÆ
 103   1        GZC_Control_Counter=0;                             //GZC¿ØÖÆ¼ÆÊýÆ÷
 104   1        
 105   1        Back_Read_Cheak=0;                                 //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬»Ø¶Á¿ØÖÆ
 106   1        Back_Read_Counter=0;                               //»Ø¶Á¿ØÖÆ¼ÆÊýÆ÷
 107   1        
 108   1        Over_Time_Cheak=0;                                 //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬³¬Ê±¼ì²â
 109   1        Over_Time_Counter=0;                               //³¬Ê±¼ì²â¼ÆÊýÆ÷
 110   1        
 111   1        Ack_Cheak=0;                                       //±êÖ¾¶¨Ê±Æ÷0µÄÓÃÍ¾£¬Ó¦´ð¼ì²â
 112   1        Ack_Cheak_Counter=0;                               //Ó¦´ð¼ì²â¼ÆÊýÆ÷
 113   1        
 114   1        Ack_Flag=0;                                        //Ó¦´ð±êÖ¾Î»
 115   1        
 116   1        
 117   1        RDI=1;                                             //RDIÎªÊäÈë¿Ú£¬ÒªÏÈÐ´Èë1
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 3   

 118   1        
 119   1        TMOD=0x22;                                         //T0ºÍT1¹¤×÷ÓÚÄ£Ê½2
 120   1        TH1=0xF8; TL1=0xF8;                                //ÉèÖÃ²¨ÌØÂÊÎª9600
 121   1        TR1=1;                                             //Æô¶¯¶¨Ê±Æ÷1
 122   1        
 123   1        TH0=0x80;TL0=0x80;                          //¶¨Ê±Æ÷0×÷Îª±¨ÎÄ·¢ËÍ¿ØÖÆµÄ¶¨Ê±»ù×¼£¬
 124   1                                  //¶¨Ê±Ê±¼äÎªÒ»Î»Êý¾Ý³¤¶ÈµÄÒ»°ë,52us
 125   1        ET0=1;                                   //¶¨Ê±Æ÷0 µÄÖÐ¶ÏÔÊÐíÎ»
 126   1        TR0=1;                                             //Æô¶¯¶¨Ê±Æ÷0
 127   1        
 128   1        SCON=0xE0;                                         //ÉèÖÃ´®¿Ú¹¤×÷ÓÚÄ£Ê½3£¬
 129   1                          //SM2ÖÃ1£¬RENÖÃ0  SCON =SM0 SM1 SM2 REN TB8 RB8 TI RI
 130   1        IP=0x12;                                           //ÉèÖÃ´®¿Ú¼°¶¨Ê±Æ÷0Îª¸ßÓÅÏÈ¼¶ÖÐ¶Ï
 131   1      }
 132          
 133          /*--------------------------------------------------------------*/
 134          /*------------------------±¨ÎÄ·¢ËÍ³ÌÐò--------------------------*/
 135          /*--------------------------------------------------------------*/
 136          void telegram_t()
 137          {
 138   1        if(Tele_Ring==0)                  //¼ì²âÊÇ·ñÓÐ±¨ÎÄÕýÔÚ½ÓÊÕ£¬Èç¹ûÓÐÔò²»ÄÜ½øÐÐ±¨ÎÄ·¢ËÍ
 139   1        {
 140   2          
 141   2          Tele_TF=0;
 142   2          Tele_TT=0;                                           //·¢ËÍ±¨ÎÄÖ¡´ÎÊý³õÊ¼»¯Îª0
 143   2          Tele_RT=0;                                      //½ÓÊÕ±¨ÎÄÖ¡´ÎÊý³õÊ¼»¯Îª0£¬ÓÃÓÚ»Ø¶Á½ÓÊÕ
 144   2          Tele_Second=0;                                      //µÚ¶þÖ¡±¨ÎÄ±êÖ¾Î»³õÊ¼»¯Îª0
 145   2          
 146   2          CRC_T=0;                                             //ÇåÁãCRCµÄÖµ
 147   2          
 148   2          CRC_R=0;
 149   2          
 150   2          Idle_Cheak=1;                                       //Æô¶¯¿ÕÏÐ¼ì²â
 151   2        }
 152   1      }
 153          
 154          
 155          /*--------------------------------------------------------------*/
 156          /*----------------------¶¨Ê±Æ÷0ÖÐ¶Ï·þÎñ³ÌÐò---------------------*/
 157          /*--------------------------------------------------------------*/
 158          void interrupt_timer0() interrupt 1                    //¶¨Ê±Æ÷0µÄÖÐ¶ÏºÅÎª1£¬52us½øÈëÒ»´Î
 159          {
 160   1        /*---------------------------GZC¿ØÖÆ--------------------------*/
 161   1        if(GZC_Control)                                      //GZC¿ØÖÆ
 162   1        {
 163   2          GZC_Control_Counter++;                             //GZC¿ØÖÆ¼ÆÊýÆ÷¼Ó1
 164   2          if(GZC_Control_Counter%2==0)          //Ê±¼äµ½´ï104us£¬ÕýºÃÊÇÒ»¸öÊý¾ÝÎ»
 165   2            GZC=!GZC;                 
 166   2          if(GZC_Control_Counter==20)     //Ò»Ö¡Êý¾Ý·¢ËÍ½áÊø  //GZC¿ØÖÆ½áÊø
 167   2          {
 168   3            GZC=1;
 169   3            GZC_Control_Counter=0;                           //Çå¿ÕGZC¿ØÖÆ¼ÆÊýÆ÷
 170   3            GZC_Control=0;                                   //Í£Ö¹GZC¿ØÖÆ
 171   3          }
 172   2        }
 173   1      /*--------------------------------------------------------------*/
 174   1      
 175   1      /*---------------------------»Ø¶Á¿ØÖÆ---------------------------*/  
 176   1        if(Back_Read_Cheak)                                  //»Ø¶Á¿ØÖÆ
 177   1        {
 178   2          Back_Read_Counter++;                               //»Ø¶Á¼ÆÊýÆ÷¼Ó1
 179   2          switch(Back_Read_Counter)                 
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 4   

 180   2          {
 181   3            case 5: Temp1_1=RDI;
 182   3                if(PDI==1) //PDI²»µÈÓÚ0µÄÇé¿öÏÂ½øÐÐ»Ø¶Á±È½Ï£¬Èç¹û»Ø¶Áµ½µÄÊýÖµ²»µÈÓÚ·¢ËÍµÄÊý¾Ý£¬Ôò½«PDIÖÃÎª0
 183   3                  if(RDI!=TDX)    //Èç¹û»Ø¶Áµ½µÄÊýÖµ²»µÈÓÚ·¢ËÍµÄÊý¾Ý£¬Ôò½«PDIÖÃÎª0
 184   3                    PDI=0;
 185   3                    break;
 186   3            case 9: Temp1_3=RDI;
 187   3                if(PDI==1)                //PDI²»µÈÓÚ0µÄÇé¿öÏÂ½øÐÐ»Ø¶Á±È½Ï£¬Èç¹û»Ø¶Áµ½µÄÊýÖµ²»µÈÓÚ·¢ËÍµÄÊý¾Ý£¬Ôò½«PDI
             -ÖÃÎª0
 188   3                  if(RDI!=TDX)   
 189   3                    PDI=0;
 190   3                    break;
 191   3            case 13: Temp1_5=RDI;
 192   3                if(PDI==1)                             //PDI²»µÈÓÚ0µÄÇé¿öÏÂ½øÐÐ»Ø¶Á±È½Ï£¬Èç¹û»Ø¶Áµ½µÄÊýÖµ²»µÈÓÚ·¢ËÍµÄ
             -Êý¾Ý£¬Ôò½«PDIÖÃÎª0
 193   3                  if(RDI!=TDX)  
 194   3                    PDI=0;
 195   3                     break;
 196   3            case 17: Temp1_7=RDI;
 197   3                      if(PDI==1)                             //PDI²»µÈÓÚ0µÄÇé¿öÏÂ½øÐÐ»Ø¶Á±È½Ï£¬Èç¹û»Ø¶Áµ½µÄÊýÖµ²»µÈÓÚ·¢Ë
             -ÍµÄÊý¾Ý£¬Ôò½«PDIÖÃÎª0
 198   3                        if(RDI!=TDX)  
 199   3                          PDI=0;
 200   3                     Back_Read_Cheak=0;                      //Í£Ö¹»Ø¶Á
 201   3                     Back_Read_Counter=0;                    //Çå¿Õ»Ø¶Á¼ÆÊýÆ÷£¬ÎªÏÂÒ»´Î»Ø¶Á¼ì²â×ö×¼±¸
 202   3                     r[Tele_RT]=Temp1;          //½ÓÊÕ»º´æÇøµÄµÚÒ»Ö¡
 203   3                           Tele_RT++;
 204   3                     CRC_R=CRC_Table[CRC_R^Temp1];           //½øÐÐCRC¼ÆËã
 205   3                     break;           
 206   3          }   
 207   2        }
 208   1      /*--------------------------------------------------------------*/
 209   1        
 210   1      /*-----------------------------¿ÕÏÐ¼ì²â-------------------------*/
 211   1        if(Idle_Cheak)                                       //¿ÕÏÐ¼ì²â£¬Á¬ÐøIDLE_TIMEÎ»Êý¾ÝÎª1£¬ÔòÈÏÎª×ÜÏß¿ÕÏÐ
 212   1        {
 213   2          if(RDI==1)                            //»Ø¶ÁÐÅºÅ¼ì²âµ½×ÜÏßÊ¼ÖÕµÈÓÚ1£¬¿ÕÏÐ¼ì²â¼ÆÊýÆ÷¼Ó1
 214   2            Idle_Cheak_Counter++;
 215   2          else
 216   2            Idle_Cheak_Counter=0;
 217   2          if(Idle_Cheak_Counter>IDLE_TIME)  //IDLE_TIMEÏàµ±ÓÚ 64*52us//×ÜÏß¿ÕÏÐ£¬·¢ËÍµÚÒ»Ö¡Êý¾Ý
 218   2          {
 219   3            GZC=0;                                            //ÖÃÎ»GZCµÄ³õÊ¼×´Ì¬
 220   3            TB8=1;                                           //ÉèÖÃµÚ¾ÅÎ»·¢ËÍÊý¾ÝÎª1--µØÖ·Ö¡
 221   3            PDI=1;                                           //È¡Ïû¸ß×è×´Ì¬£¬ÔÊÐí·¢ËÍÊý¾Ý
 222   3            REN=0;                                           //½ûÖ¹½ÓÊÕÊý¾Ý
 223   3            SBUF=ID1;                                        //µÚÒ»Ö¡Ð´SBUF
 224   3            while(TDX)          //Êý¾ÝÐ´ÈëSBUF²»ÊÇÁ¢¼´·¢ËÍ£¬·¢ËÍÊý¾ÝµÄÆðÊ¼Î»µÈ0£¬¾ÍÌø¹ýÁË
 225   3              PDI=RDI;        //×ÜÏßÉÏÃ»Êý¾Ý£¬µÈ1£¬»Ø¶ÁRDI=0£¬PDI=0£¬×ÜÏß¸ß×è
 226   3          //  if(PDI==0)
 227   3          //    a=~a;b=~b;      
 228   3            TL0=0x80;                                  //ÖØÐÂ¶Ô×¼¶¨Ê±Æ÷
 229   3            GZC_Control=1;                                 //¿ªÊ¼GZC¿ØÖÆ
 230   3            Back_Read_Cheak=1;                               //¿ªÊ¼»Ø¶Á¼ì²â
 231   3            Tele_Second=1;                                   //µÚ¶þÖ¡Êý¾Ý·¢ËÍ±êÖ¾Î»ÖÃ1
 232   3            Temp1=0xFF;                                      //½«Î»±äÁ¿ÖÃÎªFF£¬ÒÔ±ãÓÚ»Ø¶ÁÊý¾ÝµÄ±£´æ
 233   3            Idle_Cheak=0;                                    //Í£Ö¹¿ÕÏÐ¼ì²â
 234   3            Idle_Cheak_Counter=0;                            //¿ÕÏÐ¼ì²â¼ÆÊýÆ÷ÇåÁã
 235   3            CRC_T=CRC_Table[CRC_T^ID1];             //·¢ËÍµÄCRC¼ìÑé   
 236   3            
 237   3            Tele_TT++;      //=1              //±¨ÎÄ·¢ËÍ¼ÆÊýÖµ¼Ó1
 238   3          }
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 5   

 239   2        }
 240   1      /*--------------------------------------------------------------*/  
 241   1        
 242   1      /*----------------------------³¬Ê±¼ì²â--------------------------*/  
 243   1        if(Over_Time_Cheak)                                  //³¬Ê±¼ì²â
 244   1        {
 245   2          Over_Time_Counter++;                               //³¬Ê±¼ì²â¼ÆÊýÆ÷¼Ó1
 246   2          if(Over_Time_Counter==OVER_TIME)                   //±¨ÎÄ½ÓÊÕ³¬Ê±
 247   2          {
 248   3            
 249   3            Over_Time_Cheak=0;                               //Í£Ö¹³¬Ê±¼ì²â
 250   3            Over_Time_Counter=0;                             //ÇåÁã³¬Ê±¼ÆÊýÆ÷
 251   3            Tele_Ring=0;
 252   3            SM2=1;                      //Èô³¬Ê±½ÓÊÕ±¨ÎÄ£¬SM2ÖÃ1
 253   3            Tele_RT=0;                                       //ÇåÁãTele_RT
 254   3            CRC_R=0;                                         //ÇåÁãCRC_RµÄÖµ£¬·ÅÆúÖ®Ç°¼ÆËãµÄÖµ  
 255   3          }
 256   2        } 
 257   1      /*-------------------------------------------------------------*/ 
 258   1      
 259   1      /*----------------------------È·ÈÏ¼ì²â-------------------------*/
 260   1        if(Ack_Cheak)               //Ò»Ö¡Êý¾Ý·¢ËÍÍê³Éºó£¬ÔÚÒ»¶¨µÄÊ±¼äÄÜ½ÓÊÕµ½È·ÈÏÐÅºÅ
 261   1        {
 262   2          Ack_Cheak_Counter++;
 263   2          if(Ack_Cheak_Counter==ACK_TIME)
 264   2          {
 265   3            Ack_Cheak=0;
 266   3            Ack_Cheak_Counter=0;
 267   3            Tele_TF=1;
 268   3            Retry_Time++;
 269   3            if(Retry_Time==3)
 270   3            {
 271   4              Tele_TF=0;
 272   4              Tele_Cheak_T=1;
 273   4              Retry_Time=0;
 274   4            }
 275   3            SM2=1;
 276   3          }
 277   2        }
 278   1      }
 279          
 280          /*--------------------------------------------------------------*/
 281          /*-----------------------´®¿ÚÖÐ¶Ï³ÌÐò---------------------------*/
 282          /*--------------------------------------------------------------*/
 283          void interrupt_uart()    interrupt 4                  //ÖÐ¶ÏºÅÎª4
 284          {
 285   1      /*-----------------------±¨ÎÄ½ÓÊÕ´¦Àí³ÌÐò-----------------------*/  
 286   1        if(RI==1)                         
 287   1        {
 288   2          RI=0;                                            //ÇåÁã½ÓÊÕ±êÖ¾Î»RI
 289   2          Temp2=SBUF;                                      //µÚÒ»Ê±¼ä¶ÁÈ¡SBUF
 290   2          Over_Time_Cheak=0;                               //Í£Ö¹³¬Ê±¼ì²â
 291   2          Over_Time_Counter=0;                             //Çå¿Õ³¬Ê±¼ì²â¼ÆÊýÆ÷
 292   2          if(Ack_Cheak==0)
 293   2          {
 294   3            Tele_Ring=1;                                //¼ì²âÕýÔÚ½ÓÊÕ±¨ÎÄ
 295   3            if(Tele_RT<2)               //½ÓÊÕ±¨ÎÄµÄÇ°£²Ö¡·¢ËÍÄ£¿éµÄID
 296   3            {
 297   4              r[Tele_RT]=Temp2;           //½ÓÊÕµÄ±¨ÎÄÐ´Èër[0],r[1]·¢ËÍÄ£¿éID
 298   4              Tele_RT++;                
 299   4                      
 300   4              CRC_R=CRC_Table[CRC_R^Temp2];     //½øÐÐÒ»´ÎCRC¼ìÑé
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 6   

 301   4              Over_Time_Cheak=1;            //¿ªÆô³¬Ê±¼ì²â
 302   4            }
 303   3            else if(Tele_RT==2)             //½ÓÊÕµ½´ïµÚ3Ö¡£¬±¨ÎÄÊôÐÔÖ¡
 304   3            {
 305   4              
 306   4              if((Temp2&0xC0)!=0x80)          //²»ÊÇ·´À¡±¨ÎÄ£¬ÊÇÁíÍâµÄÈýÖÖ±¨ÎÄ¾Í½ÓÊÕ
 307   4              {
 308   5                r[Tele_RT]=Temp2;         //½ÓÊÕ±¨ÎÄµÄµÚ3Ö¡
 309   5                Attribute=r[Tele_RT];       //ÊôÐÔ
 310   5                Tele_RT++;
 311   5                
 312   5                CRC_R=CRC_Table[CRC_R^Temp2];
 313   5                Over_Time_Cheak=1;        
 314   5              }
 315   4              else                //ÊÇ·´À¡±¨ÎÄ£¬Ö÷Ä£¿é¾Í²»½ÓÊÕ
 316   4              {
 317   5                            //´Ë´Î±¨ÎÄ²»ÊÇ·¢ËÍ¸ø±¾Ä£¿éµÄ
 318   5                Tele_RT=0;            //ÇåÁãTele_RT,·ÅÆúÇ°ÃæËù±£´æµÄÊý¾Ý
 319   5              
 320   5                CRC_R=0; 
 321   5                Tele_Ring=0;
 322   5              }
 323   4            }
 324   3            else if(Tele_RT<4)        //µÚ4Ö¡½ö½øÐÐCRCÐ£Ñé£¬Ã»±£´æµ½r[]
 325   3            {       
 326   4              Tele_RT++;
 327   4              
 328   4              CRC_R=CRC_Table[CRC_R^Temp2];
 329   4              Over_Time_Cheak=1;
 330   4            }
 331   3            else if(Tele_RT==4)       //µÚ5Ö¡--½ÓÊÕÄ£¿éID»òÕß½ÓÊÕ×éID
 332   3            {
 333   4              if((Attribute&0x10))          //ÊôÐÔÖ¡Îª×é
 334   4              {
 335   5                if((ID_GP_Q[2]>>(Temp2-1))&0x01)
 336   5                {
 337   6                    SM2=0;                      //SM2Îª0£¬ ½ÓÊÕ·¢ËÍÄ£¿é·¢À´µÄºóÐøÊý¾Ý£¬²»ÂÛRB8=1»òÕß0
 338   6                    Group_b=Temp2;            
 339   6                    Tele_RT++;                                   //½ÓÊÜÖ¡´ÎÊý¼Ó1
 340   6                      Group_Operate_Flag=1;                          
 341   6                    CRC_R=CRC_Table[CRC_R^Temp2];
 342   6                    Over_Time_Cheak=1;                      //¶¨Ê±Æ÷2ÓÃÍ¾±êÖ¾Î»ÖÃ1£¬Æô¶¯±¨ÎÄ³¬Ê±¼ì²â            
 343   6                }
 344   5                else
 345   5                {           
 346   6                  Tele_RT=0;        //´Ë´Î±¨ÎÄ²»ÊÇ·¢ËÍ¸ø±¾Ä£¿éµÄ£¬ÇåÁãTele_RT,·ÅÆúÇ°ÃæËù±£´æµÄÊý¾Ý            
 347   6                  CRC_R=0; 
 348   6                  Tele_Ring=0;
 349   6                }
 350   5              }
 351   4              else if((Attribute&0x10)==0x00)
 352   4              {
 353   5                if(Temp2==ID||Temp2==0x03)  //Èç¹ûÏàÍ¬£¬ÔòËµÃ÷´Ë±¨ÎÄÊÇ·¢ËÍ¸ø±¾Ä£¿éµÄ£¬Ê¹SM2Î»Îª0£¬ÒÔ½ÓÊÕºóÐøÊý¾Ý
 354   5                {
 355   6                  SM2=0;                      //SM2Îª0£¬ ½ÓÊÕ·¢ËÍÄ£¿é·¢À´µÄºóÐøÊý¾Ý£¬²»ÂÛRB8=1»òÕß0
 356   6                
 357   6                  Tele_RT++;                                   //½ÓÊÜÖ¡´ÎÊý¼Ó1
 358   6                    Module_Operate_Flag=1;                          
 359   6                  CRC_R=CRC_Table[CRC_R^Temp2];
 360   6                  Over_Time_Cheak=1;                      //¶¨Ê±Æ÷2ÓÃÍ¾±êÖ¾Î»ÖÃ1£¬Æô¶¯±¨ÎÄ³¬Ê±¼ì²â  
 361   6                } 
 362   5                else
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 7   

 363   5                {         
 364   6                  Tele_RT=0;        //´Ë´Î±¨ÎÄ²»ÊÇ·¢ËÍ¸ø±¾Ä£¿éµÄ£¬ÇåÁãTele_RT,·ÅÆúÇ°ÃæËù±£´æµÄÊý¾Ý            
 365   6                  CRC_R=0; 
 366   6                  Tele_Ring=0;
 367   6                }
 368   5              }
 369   4            }
 370   3                        
 371   3            else if(Tele_RT<((r[2]&0x0F)+6-1))      //ÕûÌõ±¨ÎÄÖ¡Êý-1
 372   3            {
 373   4              
 374   4              r[Tele_RT-2]=Temp2;                        //½«Êý¾Ý±£´æµ½rÖÐ
 375   4              Tele_RT++;                                   //½ÓÊÜÖ¡´ÎÊý¼Ó1
 376   4                                          
 377   4              CRC_R=CRC_Table[CRC_R^Temp2];
 378   4              Over_Time_Cheak=1;                
 379   4            }
 380   3            else 
 381   3            {
 382   4                    
 383   4              if(Temp2==CRC_R)            //½ÓÊÕ±¨ÎÄµÄ×îºóÒ»Ö¡CRCÖ¡
 384   4              {
 385   5              
 386   5                PDI=1;
 387   5                TB8=0;
 388   5                REN=0;
 389   5                SBUF=0xAA;              //Ïò·¢ËÍÄ£¿é·µ»ØÒ»¸öÓ¦´ðÎ»0xAA
 390   5                Ack_Flag=1;
 391   5                write_tele_r(r,(Tele_RT-2));        // ¼õÈ¥ÁËµÚ4,5Ö¡[ÈºID,½ÓÊÕÄ£¿éID,CRCÖ¡]
 392   5              }
 393   4              
 394   4              
 395   4              CRC_R=0;                                   //ÇåÁãCRC_RµÄÖµ£¬×¼±¸ÏÂ´Î½ÓÊÕ±¨ÎÄ¼ÆËã
 396   4              Tele_Ring=0;              //±¨ÎÄ½ÓÊÕ½áÊø
 397   4              SM2=1;                                     //ÖÃÎ»SM2£¬×¼±¸½ÓÊÕÐÂµÄ±¨ÎÄ
 398   4              Tele_RT=0;                                 //»Ö¸´Tele_RT,×¼±¸½ÓÊÕÐÂµÄ±¨ÎÄ
 399   4            }
 400   3          }
 401   2          else//if(Ask_Cheak==1)
 402   2          {
 403   3            Ack_Cheak=0;
 404   3            Ack_Cheak_Counter=0;
 405   3          
 406   3            if(1)
 407   3            //if(Temp2==0xAA)
 408   3            {
 409   4              
 410   4              Tele_Cheak_T=1;
 411   4              Retry_Time=0;
 412   4            }
 413   3            else
 414   3            {
 415   4              Tele_TF=1;
 416   4              Retry_Time++;
 417   4              if(Retry_Time==3)
 418   4              {
 419   5                Tele_TF=0;
 420   5                Tele_Cheak_T=1;
 421   5                Retry_Time=0;
 422   5              }
 423   4            }
 424   3            SM2=1;
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 8   

 425   3          }
 426   2        } 
 427   1      /*--------------------------------------------------------------*/
 428   1        
 429   1      /*-----------------------±¨ÎÄ·¢ËÍ´¦Àí³ÌÐò-----------------------*/  
 430   1        else if(Ack_Flag)                 //·¢ËÍÓ¦´ð
 431   1        {       
 432   2          TI=0;
 433   2          PDI=0;
 434   2          Ack_Flag=0;
 435   2          REN=1;
 436   2        }
 437   1        else if(PDI==0)                                    //Î´È¡µÃ×ÜÏß¿ØÖÆÈ¨ 
 438   1        {         
 439   2          REN=1;                                           //»Ö¸´±¨ÎÄ½ÓÊÕ
 440   2          Tele_Ring=1;                                     //ÕýÔÚ½ÓÊÕ±¨ÎÄ
 441   2          TI=0;                                            //Çå¿Õ·¢ËÍ±êÖ¾Î»
 442   2          Tele_TF=1;                                       //±¨ÎÄÎ´³É¹¦·¢ËÍ£¬ÖÃÎ»±¨ÎÄ·¢ËÍ±êÖ¾Î»
 443   2          Retry_Time++;                                    //ÖØÊÔ´ÎÊý¼Ó1
 444   2          Over_Time_Cheak=1;                               //Æô¶¯±¨ÎÄ³¬Ê±¼ì²â
 445   2          CRC_T=0;                                         //·ÅÆúÖ®Ç°¼ÆËãµÄ·¢ËÍCRC
 446   2          
 447   2          if(Retry_Time==10)                               //ÖØÊÔ10´Î¶¼Ã»ÓÐ·¢ËÍ³öÈ¥£¬Ôò·ÅÆú´ËÌõ±¨ÎÄ
 448   2          {
 449   3            Tele_TF=0;
 450   3            Tele_Cheak_T=1;
 451   3            Retry_Time=0;
 452   3          }
 453   2        }
 454   1        
 455   1        else if(Tele_Second)                               //½øÐÐµÚ¶þÖ¡Êý¾Ý·¢ËÍ±êÖ¾Î»
 456   1        {
 457   2          TI=0;                                            //µÚÒ»Ê±¼äÇåÁã·¢ËÍÖÐ¶Ï±êÖ¾Î»
 458   2          GZC=0;                                           //µÚ¶þÖ¡Êý¾Ý£¬»¹ÊÇÓÃ¸ß×è´ú±í1                     
 459   2          TB8=1;                                           //ÉèÖÃµÚ°ËÎ»·¢ËÍÊý¾ÝÎª1
 460   2          SBUF=ID2;                                        //µÚ¶þÖ¡Êý¾ÝÐ´ÈëSBUF
 461   2          while(TDX)
 462   2            PDI=RDI;    
 463   2          TL0=0x80;                                        //ÖØÐÂ¶Ô×¼¶¨Ê±Æ÷
 464   2          GZC_Control=1;                                   //Æô¶¯GZC¿ØÖÆ
 465   2          Back_Read_Cheak=1;                               //Æô¶¯»Ø¶Á¼ì²â
 466   2          Tele_Second=0;                                   //µÚ¶þÖ¡±êÖ¾Î»ÇåÁã
 467   2          Tele_TT++;                 //=2                      //·¢ËÍÊý¾ÝÖ¡´ÎÊý¼Ó1
 468   2          CRC_T=CRC_Table[CRC_T^ID2];
 469   2          
 470   2        } 
 471   1        else                                               //½øÐÐÕý³£Êý¾Ý·¢ËÍ
 472   1        {
 473   2          TI=0;                                            //µÚÒ»Ê±¼äÇåÁã·¢ËÍÖÐ¶Ï±êÖ¾Î» 
 474   2          Tele_RT=0;                                       //ÇåÁãTele_RT£¬·ÅÆú»Ø¶ÁÊ±±£´æµÄÊý¾Ý
 475   2          CRC_R=0;                                         //ÇåÁãCRC_RµÄÖµ£¬·ÅÆúÖ®Ç°¼ÆËãµÄÖµ
 476   2          
 477   2          Tele_TT++;                //==3
 478   2      
 479   2          if(Tele_TT>5)                 //ÔÚ¿ØÖÆÓò·¢ËÍÍêÖ®ºóÖÃTB8=0         
 480   2            TB8=0;                     
 481   2          else
 482   2            TB8=1;        
 483   2          
 484   2          if(Tele_TT<(Frame_Num_T+3))                          //¼ì²âÊý¾ÝÖ¡ÊÇ·ñ·¢ËÍÍê
 485   2          {
 486   3            SBUF=t[Tele_TT-3];              //µÚÈýÖ¡¿ªÊ¼·¢¡¾±¨ÎÄÊôÐÔ£¬½ÓÊÕÈºID...... ¡¿
C51 COMPILER V9.50a   TELE_T_R                                                             07/17/2017 17:31:02 PAGE 9   

 487   3            CRC_T=CRC_Table[CRC_T^t[Tele_TT-3]];
 488   3          
 489   3          }
 490   2          else if(Tele_TT==(Frame_Num_T+3))                  //¼ì²â×îºóÒ»Ö¡£¬·¢ËÍCRCÐ§ÑéÂë
 491   2          {
 492   3            SBUF=CRC_T;                                   //·¢ËÍCRCÐ§ÑéÂë
 493   3      //      Retry_Time=0;                 
 494   3          }
 495   2          else                                             //ËùÓÐÖ¡·¢ËÍÍê
 496   2          {
 497   3            
 498   3            REN=1;                                         //»Ö¸´½ÓÊÕÔÊÐí
 499   3            PDI=0;                                         //±£³Ö×ÜÏß¸ß×è
 500   3            if((t[0]&0xC0)!=0x80)                          /*Ö¸Áî¡¢ÅäÖÃ¡¢²éÑ¯£¬±¨ÎÄÐèÒªÈ·ÈÏÖ¡*/
 501   3            {
 502   4              SM2=0;                        //·¢ËÍÄ£¿éÒ»Ö¡Êý¾Ý·¢ËÍÍê±Ïºó£¬×¼±¸½ÓÊÕÈ·ÈÏÖ¡
 503   4              Ack_Cheak=1;             //Æô¶¯È·ÈÏ³¬Ê±¼ì²â£¬ÔÚ¹æ¶¨µÄÊ±¼äÄÚ±¨ÎÄ½ÓÊÕ½ÚµãÒª·µ»ØÈ·ÈÏÖ¡
 504   4            }
 505   3            else                                  /*Èç¹ûÊÇ·´À¡±¨ÎÄ£¬Ö±½ÓÖÃÎ»±¨ÎÄ·¢ËÍ¼ì²â±êÖ¾Î»*/
 506   3              Tele_Cheak_T=1;         //ÈôÊÇ·´À¡±¨ÎÄ£¬°Ñ·¢ËÍ¶ÓÁÐµÄ±¨ÎÄ¶Á³öÀ´
 507   3          }                   
 508   2        }
 509   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1004    ----
   CONSTANT SIZE    =    256    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     41    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     11    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
